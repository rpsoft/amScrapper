{"version":3,"sources":["amazonScrapper.js"],"names":["url","require","http","cheerio","Promise","amazon","client","createClient","awsId","awsSecret","awsTag","domain","pausecomp","millis","date","Date","curDate","exports","getProductIDS","seedURL","console","log","Resolve","Reject","error","resp","body","productIds","$","load","each","i","elem","rating","find","text","replace","parseFloat","substring","indexOf","numberRaters","parseInt","children","push","attr","toReturn","e","getLowestUsedPriceData","productID","cheapestUsed","first","trim","cheapestCondition1","split","cheapestCondition2","sellerStarRating","percentPositive","getProductReviewDates","maxPage","prev","latestReviewDate","firstReview","getProductEarliestReviewDate","last","getDataForProduct","pid","itemLookup","ItemId","responseGroup","then","results","catch","err","JSON","stringify"],"mappings":"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","file":"amazonScrapper.js","sourcesContent":["var url = require('url');\nvar http = require(\"request\");\nvar cheerio = require('cheerio');\nvar Promise = require('es6-promise').Promise;\nvar amazon = require('amazon-product-api');\n\nvar client = amazon.createClient({\n  awsId: \"AKIAI7UIBW6PANJASE6A\",\n  awsSecret: \"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\",\n  awsTag: \"datagatherer\"\n});\n\nvar domain = \"co.uk\"\n\nfunction pausecomp(millis) // The ultimate stop for a few millis script.\n{\nvar date = new Date();\nvar curDate = null;\n\ndo { curDate = new Date(); }\nwhile(curDate-date < millis);\n}\n\nexports.getProductIDS =  async function (seedURL){\n     console.log(seedURL)\n    return new Promise( function (Resolve,Reject){\n      try{\n\n        http(seedURL, function(error, resp, body){\n          var productIds = [];\n          var $;\n\n          if ( resp && 'request' in resp ) {\n\n            $ = cheerio.load(body);\n          //  console.log(body);\n\n            $(\".s-result-item\").each(function(i, elem) {\n\n              var rating = $(this).find(\".a-icon-alt\").text().replace(\"Prime\",\"\");\n              rating = parseFloat(rating.substring(0,rating.indexOf(\" \")));\n              var numberRaters = parseInt($(this).find(\".s-item-container\").children(\":last-child\").children(\":last-child\").text().replace(\",\",\"\"));\n\n              //console.log(rating+\" -- \"+numberRaters);\n\n              productIds.push({ \"productId\" : $(this).attr(\"data-asin\"), \"starRating\" : rating, \"numberRaters\": numberRaters } );\n            });\n\n            var toReturn = {\"pids\" : productIds, \"nextUrl\" : $(\"#pagnNextLink\").attr(\"href\")}\n\n            Resolve(toReturn);\n          } else {\n            Reject(\"boom\");\n          }\n        });\n\n      } catch (e){\n        console.log(e)\n        Reject(e);\n      }\n    });\n}\n\nexports.getLowestUsedPriceData = async function (productID){\n  return new Promise( function (Resolve,Reject){\n    try{\n\n\n      http(\"https://www.amazon.\"+domain+\"/gp/offer-listing/\"+productID+\"/ref=dp_olp_used?ie=UTF8&condition=used\", async function(error, resp, body){\n\n        var $;\n\n        if ( resp && 'request' in resp ) {\n\n          $ = cheerio.load(body);\n\n          if ( $(\"body\").find(\".olpOfferPrice\") ){\n\n            var cheapestUsed = $(\"body\").find(\".olpOfferPrice\").first().text().trim();\n            var cheapestCondition1 = $(\"body\").find(\".olpCondition\").first().text().trim().replace(\"\\n                - \",\",\").split(\",\")[0];\n            var cheapestCondition2 = $(\"body\").find(\".olpCondition\").first().text().trim().replace(\"\\n                - \",\",\").split(\",\")[1];\n            var sellerStarRating = $(\"body\").find(\".olpSellerColumn\").first().find(\"p:nth-child(2)\").find(\"i:nth-child(1)\").text().trim();\n            var percentPositive = $(\"body\").find(\".olpSellerColumn\").first().find(\"p:nth-child(2)\").find(\"a:nth-child(2)\").text();\n\n\n            Resolve({\"cheapestUsed\": cheapestUsed,\n                     \"cheapestCondition1\": cheapestCondition1,\n                     \"cheapestCondition2\": cheapestCondition2,\n                     \"sellerStarRating\": sellerStarRating,\n                     \"percentPositive\": percentPositive,\n                   });\n\n          }\n\n        }\n\n\n      });\n\n    } catch ( e){\n      console.log(e)\n      Reject(e);\n    }\n\n  });\n};\n\n\n\nexports.getProductReviewDates =  async function (productID){\n\n    return new Promise( function (Resolve,Reject){\n      try{\n\n        http(\"https://www.amazon.\"+domain+\"/product-reviews/\"+productID+\"?sortBy=recent\", async function(error, resp, body){\n\n          var $;\n\n          if ( resp && 'request' in resp ) {\n\n            $ = cheerio.load(body);\n            //console.log(body);\n\n            var maxPage = $(\".a-last\").prev().text();\n          //  console.log(\"maxPage: \"+maxPage);\n\n\n            var latestReviewDate = $(\".a-section .review\").first().children(\":nth-child(2)\").find(\".review-date\").text();\n\n            var firstReview;\n            if (maxPage){\n              pausecomp(1000);\n              firstReview = await getProductEarliestReviewDate(productID,maxPage);\n            } else {\n              firstReview = $(\".a-section .review\").last().children(\":nth-child(2)\").find(\".review-date\").text();\n            }\n\n          //  console.log(latestReviewDate + \" --- \"+ firstReview);\n            latestReviewDate = latestReviewDate.replace(\"on \",\"\" );\n            firstReview = firstReview.replace(\"on \",\"\" );\n\n            var toReturn = {\"latestReviewDate\":latestReviewDate, \"firstReviewDate\":firstReview};\n            //console(\"esto return: \"+toReturn);\n            Resolve(toReturn);\n          } else {\n            Reject(\"boom\");\n          }\n        });\n\n      } catch (e){\n        console.log(e)\n        Reject(e);\n      }\n    });\n}\n\nasync function getProductEarliestReviewDate(productID,maxPage){\n\n    return new Promise( function (Resolve,Reject){\n      try{\n\n        http(\"https://www.amazon.\"+domain+\"/product-reviews/\"+productID+\"?sortBy=recent&pageNumber=\"+parseInt(maxPage), function(error, resp, body){\n\n          var $;\n\n          if ( resp && 'request' in resp ) {\n\n            $ = cheerio.load(body);\n\n            var firstReview = $(\".a-section .review\").last().children(\":nth-child(2)\").find(\".review-date\").text();\n            //console.log(\"Earliest review: \"+ firstReview);\n\n            Resolve(firstReview);\n          } else {\n            Reject(\"boom\");\n          }\n        });\n\n      } catch (e){\n        console.log(e)\n        Reject(e);\n      }\n    });\n}\n\n\nexports.getDataForProduct = async function(pid){\n  return new Promise( function (Resolve,Reject){\n\n  client.itemLookup({\n      //searchIndex: 'Electronics',\n      ItemId: pid,\n      responseGroup: 'ItemAttributes,Offers,Reviews,SalesRank',\n      //ItemPage: page\n    }).then(function(results){\n      //console.log(JSON.stringify(results));\n      Resolve(results);\n    }).catch(function(err){\n      Reject(null);\n      console.log(JSON.stringify(err));\n    });\n\n});\n};\n"]}